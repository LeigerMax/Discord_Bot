/**
 * @file Spam Command
 * @description Spam un joueur avec des mentions dans le salon et DM puis supprime tout automatiquement
 * @module commands/fun/spam
 * @category Fun
 * @requires discord.js
 */

const { EmbedBuilder } = require('discord.js');

module.exports = {
  name: 'spam',
  description: 'Spam un joueur avec des mentions puis supprime tout',
  usage: '!spam @utilisateur [durÃ©e_en_secondes]',
  
  async execute(message, args) {
    try {
      // VÃ©rifie qu'un utilisateur est mentionnÃ©
      const mentionedUser = message.mentions.users.first();
      
      if (!mentionedUser) {
        return message.reply({
          content: 'âŒ **Erreur**: Tu dois mentionner un utilisateur!\n' +
                   '**Exemple**: `!spam @utilisateur` ou `!spam @utilisateur 30`'
        });
      }

      // Parse la durÃ©e (en secondes)
      let durationInSeconds = 60; // Par dÃ©faut 60 secondes
      const timeArg = args.find(arg => !arg.startsWith('<@') && !isNaN(arg));
      
      if (timeArg) {
        const parsedTime = parseInt(timeArg);
        if (parsedTime < 5) {
          return message.reply('âŒ **Erreur**: La durÃ©e minimum est de 5 secondes!');
        }
        if (parsedTime > 300) {
          return message.reply('âŒ **Erreur**: La durÃ©e maximum est de 300 secondes (5 minutes)!');
        }
        durationInSeconds = parsedTime;
      }

      const duration = durationInSeconds * 1000; // Convertir en millisecondes

      // Confirmation avant le spam
      const confirmEmbed = new EmbedBuilder()
        .setColor(0xFF6600)
        .setTitle('âš ï¸ Spam en cours!')
        .setDescription(`ğŸ¯ **Cible**: ${mentionedUser.username}\nğŸ‘¤ **LancÃ© par**: ${message.author.username}\nâ±ï¸ **DurÃ©e**: ${durationInSeconds} secondes\nğŸ’¬ **Spam canal**: Toutes les 2s\nğŸ“© **GIF DM**: Toutes les 10s\nğŸ—‘ï¸ **Nettoyage**: Automatique aprÃ¨s ${durationInSeconds}s`)
        .setFooter({ text: 'Attention, Ã§a va chauffer! ğŸ”¥' });

      await message.reply({ embeds: [confirmEmbed] });

      // Tableau pour stocker les IDs des messages crÃ©Ã©s
      const spamMessages = [];
      const startTime = Date.now();

      // Supprime le message original
      try {
        await message.delete();
      } catch (err) {
        console.log('Impossible de supprimer le message original:', err.message);
      }

      // Messages de spam variÃ©s
      const spamTexts = [
        `${mentionedUser} ğŸ‘€`,
        `Hey ${mentionedUser}! ğŸ‘‹`,
        `${mentionedUser} regarde! ğŸ‘ï¸`,
        `Coucou ${mentionedUser}! ğŸ‰`,
        `${mentionedUser} t'es lÃ ? ğŸ¤”`,
        `${mentionedUser}!!!`,
        `Ping ${mentionedUser} ğŸ””`,
        `${mentionedUser} rÃ©ponds! ğŸ“¢`,
        `Yo ${mentionedUser}! ğŸ®`,
        `${mentionedUser} wake up! â°`
      ];

      // GIFs pour les DM
      const spamGifs = [
        'https://i.giphy.com/QBd2kLB5qDmysEXre9.webp',
        'https://i.giphy.com/l0HlQ7LRalQqdWfao.webp',
        'https://i.giphy.com/H6cmWzp6LGFvqjidB7.webpp'
      ];

      // Fonction de spam en DM avec GIF toutes les 10 secondes
      const dmSpamInterval = setInterval(async () => {
        if (Date.now() - startTime >= duration) {
          clearInterval(dmSpamInterval);
          return;
        }

        try {
          const randomGif = spamGifs[Math.floor(Math.random() * spamGifs.length)];
          const gifEmbed = new EmbedBuilder()
            .setColor(0xFF0000)
            .setDescription(`ğŸ”¥ **SPAM ATTACK!** ğŸ”¥\nFrom: ${message.author.username}`)
            .setImage(randomGif)
            .setFooter({ text: 'Tu es en train de te faire spammer! ğŸ˜ˆ' });
          
          await mentionedUser.send({ embeds: [gifEmbed] });
        } catch (err) {
          console.log('Impossible d\'envoyer un DM Ã  l\'utilisateur:', err.message);
        }
      }, 10000); // Toutes les 10 secondes

      // Fonction de spam
      const spamInterval = setInterval(async () => {
        // VÃ©rifie si la durÃ©e est Ã©coulÃ©e
        if (Date.now() - startTime >= duration) {
          clearInterval(spamInterval);
          clearInterval(dmSpamInterval); // ArrÃªte aussi le spam en DM
          
          // Attendre un peu avant de nettoyer
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Supprime tous les messages de spam
          let deletedCount = 0;
          for (const msgId of spamMessages) {
            try {
              const msg = await message.channel.messages.fetch(msgId);
              await msg.delete();
              deletedCount++;
            } catch (_err) {
              console.log('Message dÃ©jÃ  supprimÃ© ou introuvable:', msgId);
            }
          }

          // Message de fin
          const endEmbed = new EmbedBuilder()
            .setColor(0x00FF00)
            .setDescription(`âœ… Spam terminÃ©!\nğŸ—‘ï¸ ${deletedCount} messages supprimÃ©s`)
            .setFooter({ text: `Victime: ${mentionedUser.username} â€¢ Par: ${message.author.username}` });

          const finalMsg = await message.channel.send({ embeds: [endEmbed] });
          
          // Supprime le message de fin aprÃ¨s 5 secondes
          setTimeout(() => {
            finalMsg.delete().catch(() => {});
          }, 5000);

          return;
        }

        // Envoie un message de spam
        try {
          const randomText = spamTexts[Math.floor(Math.random() * spamTexts.length)];
          const spamMsg = await message.channel.send(randomText);
          spamMessages.push(spamMsg.id);
        } catch (err) {
          console.error('Erreur lors de l\'envoi du spam:', err);
        }
      }, 2000); // Envoie un message toutes les 2 secondes

    } catch (error) {
      console.error('Erreur dans la commande spam:', error);
      message.reply('âŒ Une erreur est survenue lors du traitement de ta commande.');
    }
  },
};
